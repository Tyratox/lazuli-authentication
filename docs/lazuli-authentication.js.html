<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lazuli-authentication.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lazuli-authentication.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {
	FACEBOOK_CALLBACK_PATH,
	LOGIN_PATH,
	GOOGLE_CALLBACK_PATH
} = require("lazuli-require")("lazuli-config");

const graphqlHTTP = require("express-graphql");

const {
	loginView,
	oAuthDialogView,
	mailVerificationView,
	passwordResetView
} = require("./views.js");

const {
	initOauthServer,
	authenticateOauthClient,
	checkForImmediateApproval
} = require("./oauth-server.js");

const { initPassport } = require("./passport.js");

const { isBearerAuthenticated } = require("./middleware.js");
const {
	passwordReset,
	initPasswordReset,
	authFacebookCallback,
	authGoogleCallback,
	verifyEmail,
	registration,
	isAuthenticated,
	authLocal
} = require("./endpoint.js");

const {
	localLoginValidation,
	initPasswordResetValidation,
	passwordResetValidation,
	localRegistrationValidation,
	verifyMailValidation
} = require("./validation.js");

const eventEmitter = require("lazuli-require")(
	"lazuli-core/globals/event-emitter"
);
const valueFilter = require("lazuli-require")(
	"lazuli-core/globals/value-filter"
);
const sequelize = require("lazuli-require")("lazuli-core/globals/sequelize");
const { expressServer, httpServer } = require("lazuli-require")(
	"lazuli-core/globals/http-server"
);

/**
 * This is the authentication class which handles the registration and, of
 * course, the authentication of users
 */
class Authentication {
	constructor() {
		valueFilter.add("sequelize.models", this.registerModels.bind(this));
		valueFilter.add(
			"graphql.schema.root.query.fields",
			this.addGraphQlQueryFields.bind(this)
		);
		valueFilter.add(
			"graphql.schema.root.mutation.fields",
			this.addGraphQlMutationFields.bind(this)
		);

		eventEmitter.on(
			"express.init.after",
			this.addPassportMiddleware.bind(this)
		);

		valueFilter.add("graphql.middleware.before", middlewares => {
			return [...middlewares, this.isBearerAuthenticated()];
		});

		eventEmitter.on("model.init.after", this.modelsAfter.bind(this));
		eventEmitter.on("express.routing.rest", this.restRouting.bind(this));
	}
}

/**
 * The oauth 2 authentication server
 * @private
 * @type {Object}
 */
Authentication.prototype._oauth2Server = require("oauth2orize").createServer();
/**
 * The internal passport object
 * @private
 * @type {Object}
 */
Authentication.prototype._passport = require("passport");

/**
 * All models registered by this module
 * @type {Object}
 */
Authentication.prototype._models = {
	OauthAccessToken: require("./models/oauth-access-token"),
	OauthClient: require("./models/oauth-client"),
	OauthCode: require("./models/oauth-code"),
	OauthProvider: require("./models/oauth-provider"),
	OauthRedirectUri: require("./models/oauth-redirect-uri"),
	Permission: require("./models/permission"),
	User: require("./models/user")
};

/**
 * Adds all required passport middleware to the passed express server
 * @return {void}
 */
Authentication.prototype.addPassportMiddleware = function() {
	expressServer.use(this._passport.initialize());
	expressServer.use(this._passport.session());
};

/**
 * Initiates the oauth server and the passport object
 * @param  {Array} models  All registered models
 * @return {void}
 */
Authentication.prototype.modelsAfter = function(models) {
	initOauthServer(this._oauth2Server);
	initPassport(this._passport);

	this.isBearerAuthenticated = isBearerAuthenticated(this._passport);
};

/**
 * Registeres new models
 * @param  {Object} models All previously registered models
 * @return {Object}        The new model object, including the old and new
 */
Authentication.prototype.registerModels = function(models) {
	return {
		...models,
		...this._models
	};
};

/**
 * Adds a schema path in order to register the authentication related schemas
 * @param {Array} paths The schema paths to register
 * @return {Array} The modified paths value
 */
Authentication.prototype.addSchemaPath = paths => {
	return [...paths, path.join(__dirname, "schemas")];
};

/**
 * Sets up all the routing for this module
 * @return {void}
 */
Authentication.prototype.restRouting = function() {
	this._setupGetRouting();
	this._setupPostRouting();
};

/**
 * Sets up all the REST 'GET' calls
 * @private
 * @return {void}
 */
Authentication.prototype._setupGetRouting = function() {
	expressServer.get(
		"/auth/logged-in",
		this.isBearerAuthenticated(),
		(request, response, next) => {
			return response.end('{"loggedIn": true}');
		},
		(error, request, response, next) => {
			response.end('{"loggedIn": false}');
		}
	);

	expressServer.get("/views/login", loginView());

	expressServer.get("/views/verify-email", mailVerificationView());

	expressServer.get("/views/password-reset", passwordResetView());

	expressServer.get(
		"/auth/facebook/login/",
		this._passport.authenticate("facebook", { scope: ["email"] })
	);

	expressServer.get(
		FACEBOOK_CALLBACK_PATH,
		authFacebookCallback(this._passport)
	);

	expressServer.get(
		"/auth/google/login/",
		this._passport.authenticate("google", {
			scope: ["openid profile email"]
		})
	);
	expressServer.get(GOOGLE_CALLBACK_PATH, authGoogleCallback(this._passport));

	expressServer.get(
		"/oauth2/authorize",
		isAuthenticated,
		authenticateOauthClient(this._oauth2Server),
		checkForImmediateApproval(),
		oAuthDialogView()
	);
};

/**
 * Sets up all the REST 'POST' calls
 * @private
 * @return {void}
 */
Authentication.prototype._setupPostRouting = function() {
	expressServer.post(
		"/auth/local/login",
		expressServer.validate(localLoginValidation), //Tracked in analytics
		authLocal(this._passport)
	);

	expressServer.post(
		"/auth/init-password-reset",
		expressServer.validate(initPasswordResetValidation),
		initPasswordReset()
	);

	expressServer.post(
		"/auth/password-reset",
		expressServer.validate(passwordResetValidation),
		passwordReset()
	);

	expressServer.post(
		"/auth/local/register",
		expressServer.validate(localRegistrationValidation),
		registration()
	);

	expressServer.post(
		"/auth/local/verify-email",
		expressServer.validate(verifyMailValidation),
		verifyEmail()
	);

	expressServer.post(
		"/oauth2/authorize",
		isAuthenticated,
		this._oauth2Server.decision()
	);

	expressServer.post(
		"/oauth2/token",
		this._passport.authenticate("client-local", {
			session: false
		}),
		this._oauth2Server.token()
	);
};

/**
 * Adds authentication related query fields
 * @param  {Object} fields    The registered fields
 * @return {Object}           The altered query fields
 */
Authentication.prototype.addGraphQlQueryFields = fields => {
	return {
		...fields,
		...require("./schemas/user").query,
		...require("./schemas/oauth-client").query
	};
};

/**
 * Adds authentication related mutation fields
 * @param  {Object} fields    The registered fields
 * @return {Object}           The altered query fields
 */
Authentication.prototype.addGraphQlMutationFields = fields => {
	return {
		...fields,
		...require("./schemas/user").mutation,
		...require("./schemas/oauth-client").mutation
	};
};

module.exports = Authentication;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Authentication.html">Authentication</a></li></ul><h3>Global</h3><ul><li><a href="global.html#auth">auth</a></li><li><a href="global.html#authenticateOauthClient">authenticateOauthClient</a></li><li><a href="global.html#authFacebookCallback">authFacebookCallback</a></li><li><a href="global.html#authGoogleCallback">authGoogleCallback</a></li><li><a href="global.html#authLocal">authLocal</a></li><li><a href="global.html#checkForImmediateApproval">checkForImmediateApproval</a></li><li><a href="global.html#escapeLikeString">escapeLikeString</a></li><li><a href="global.html#generateHash">generateHash</a></li><li><a href="global.html#generateRandomString">generateRandomString</a></li><li><a href="global.html#initFacebookAuthentication">initFacebookAuthentication</a></li><li><a href="global.html#initGoogleAuthentication">initGoogleAuthentication</a></li><li><a href="global.html#initLocalAuthentication">initLocalAuthentication</a></li><li><a href="global.html#initOauthBearerAuthentication">initOauthBearerAuthentication</a></li><li><a href="global.html#initOauthClientAuthentication">initOauthClientAuthentication</a></li><li><a href="global.html#initOauthServer">initOauthServer</a></li><li><a href="global.html#initOauthServerExchange">initOauthServerExchange</a></li><li><a href="global.html#initOauthServerGrant">initOauthServerGrant</a></li><li><a href="global.html#initPassport">initPassport</a></li><li><a href="global.html#initPassportSerialization">initPassportSerialization</a></li><li><a href="global.html#initPasswordReset">initPasswordReset</a></li><li><a href="global.html#isAuthenticated">isAuthenticated</a></li><li><a href="global.html#isBearerAuthenticated">isBearerAuthenticated</a></li><li><a href="global.html#loginView">loginView</a></li><li><a href="global.html#mailVerificationView">mailVerificationView</a></li><li><a href="global.html#mutation">mutation</a></li><li><a href="global.html#oAuthDialogView">oAuthDialogView</a></li><li><a href="global.html#passwordReset">passwordReset</a></li><li><a href="global.html#passwordResetView">passwordResetView</a></li><li><a href="global.html#pick">pick</a></li><li><a href="global.html#protectGraphqlSchemaFields">protectGraphqlSchemaFields</a></li><li><a href="global.html#query">query</a></li><li><a href="global.html#registration">registration</a></li><li><a href="global.html#verifyEmail">verifyEmail</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Oct 22 2017 21:45:46 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
