<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>schemas/oauth-client.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-lazuli-authentication.Authentication.html">Authentication</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication.Authentication.html#.associateModels">associateModels</a></li></ul></li><li><a href="module-lazuli-authentication_input-types_oauth-client_OauthClientInputType.html">OauthClientInputType</a></li><li><a href="module-lazuli-authentication_input-types_oauth-provider_OauthProviderInputType.html">OauthProviderInputType</a></li><li><a href="module-lazuli-authentication_input-types_user_UserInputType.html">UserInputType</a></li><li><a href="module-lazuli-authentication_models_oauth-access-token.OauthAccessToken.html">OauthAccessToken</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_oauth-access-token.OauthAccessToken.html#.associate">associate</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-access-token.OauthAccessToken.html#.findByToken">findByToken</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-access-token.OauthAccessToken.html#.generateToken">generateToken</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-access-token.OauthAccessToken.html#.hashToken">hashToken</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-access-token.OauthAccessToken.html#setScopeArray">setScopeArray</a></li></ul></li><li><a href="module-lazuli-authentication_models_oauth-client.OauthClient.html">OauthClient</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_oauth-client.OauthClient.html#.associate">associate</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-client.OauthClient.html#.generateSecret">generateSecret</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-client.OauthClient.html#updateSecret">updateSecret</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-client.OauthClient.html#verifyRedirectUri">verifyRedirectUri</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-client.OauthClient.html#verifySecret">verifySecret</a></li></ul></li><li><a href="module-lazuli-authentication_models_oauth-code.OauthCode.html">OauthCode</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_oauth-code.OauthCode.html#.associate">associate</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-code.OauthCode.html#.findByCode">findByCode</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-code.OauthCode.html#.generateCode">generateCode</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-code.OauthCode.html#.hashCode">hashCode</a></li><li data-type='method'><a href="module-lazuli-authentication_models_oauth-code.OauthCode.html#setScopeArray">setScopeArray</a></li></ul></li><li><a href="module-lazuli-authentication_models_oauth-provider.OauthProvider.html">OauthProvider</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_oauth-provider.OauthProvider.html#.associate">associate</a></li></ul></li><li><a href="module-lazuli-authentication_models_oauth-redirect-uri.OauthRedirectUri.html">OauthRedirectUri</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_oauth-redirect-uri.OauthRedirectUri.html#.associate">associate</a></li></ul></li><li><a href="module-lazuli-authentication_models_oauth-scope.OauthScope.html">OauthScope</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_oauth-scope.OauthScope.html#.associate">associate</a></li></ul></li><li><a href="module-lazuli-authentication_models_permission.Permission.html">Permission</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_permission.Permission.html#.associate">associate</a></li></ul></li><li><a href="module-lazuli-authentication_models_user.User.html">User</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#._createFromPassportProfile">_createFromPassportProfile</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#.associate">associate</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#.findOrCreateUserByPassportProfile">findOrCreateUserByPassportProfile</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#.getUserByPassportProfile">getUserByPassportProfile</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#.register">register</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#_updateFromPassportProfile">_updateFromPassportProfile</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#can">can</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#initEmailVerification">initEmailVerification</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#initPasswordReset">initPasswordReset</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#setPermissionArray">setPermissionArray</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#updatePassword">updatePassword</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#verifyEmail">verifyEmail</a></li><li data-type='method'><a href="module-lazuli-authentication_models_user.User.html#verifyPassword">verifyPassword</a></li></ul></li><li><a href="module-lazuli-authentication_types_oauth-acccess-token_OauthAccessTokenType.html">OauthAccessTokenType</a></li><li><a href="module-lazuli-authentication_types_oauth-client_OauthClientType.html">OauthClientType</a></li><li><a href="module-lazuli-authentication_types_oauth-code_OauthCodeType.html">OauthCodeType</a></li><li><a href="module-lazuli-authentication_types_oauth-provider_OauthProviderType.html">OauthProviderType</a></li><li><a href="module-lazuli-authentication_types_oauth-redirect-uri_OauthRedirectUriType.html">OauthRedirectUriType</a></li><li><a href="module-lazuli-authentication_types_oauth-scope_OauthScopeType.html">OauthScopeType</a></li><li><a href="module-lazuli-authentication_types_permission_PermissionType.html">PermissionType</a></li><li><a href="module-lazuli-authentication_types_user_UserType.html">UserType</a></li></ul><h3>Modules</h3><ul><li><a href="module-lazuli-authentication.html">lazuli-authentication</a></li><li><a href="module-lazuli-authentication_graphql-validation_oauth-client.html">lazuli-authentication/graphql-validation/oauth-client</a></li><li><a href="module-lazuli-authentication_graphql-validation_user.html">lazuli-authentication/graphql-validation/user</a></li><li><a href="module-lazuli-authentication_input-types_oauth-client.html">lazuli-authentication/input-types/oauth-client</a></li><li><a href="module-lazuli-authentication_input-types_oauth-provider.html">lazuli-authentication/input-types/oauth-provider</a></li><li><a href="module-lazuli-authentication_input-types_user.html">lazuli-authentication/input-types/user</a></li><li><a href="module-lazuli-authentication_middleware.html">lazuli-authentication/middleware</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_middleware.html#.isUserLoggedIn">isUserLoggedIn</a></li></ul></li><li><a href="module-lazuli-authentication_models_oauth-access-token.html">lazuli-authentication/models/oauth-access-token</a></li><li><a href="module-lazuli-authentication_models_oauth-client.html">lazuli-authentication/models/oauth-client</a></li><li><a href="module-lazuli-authentication_models_oauth-code.html">lazuli-authentication/models/oauth-code</a></li><li><a href="module-lazuli-authentication_models_oauth-provider.html">lazuli-authentication/models/oauth-provider</a></li><li><a href="module-lazuli-authentication_models_oauth-redirect-uri.html">lazuli-authentication/models/oauth-redirect-uri</a></li><li><a href="module-lazuli-authentication_models_oauth-scope.html">lazuli-authentication/models/oauth-scope</a></li><li><a href="module-lazuli-authentication_models_permission.html">lazuli-authentication/models/permission</a></li><li><a href="module-lazuli-authentication_models_user.html">lazuli-authentication/models/user</a></li><li><a href="module-lazuli-authentication_oauth-server.html">lazuli-authentication/oauth-server</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_oauth-server.html#~initOauthServer">initOauthServer</a></li><li data-type='method'><a href="module-lazuli-authentication_oauth-server.html#~initOauthServerExchange">initOauthServerExchange</a></li><li data-type='method'><a href="module-lazuli-authentication_oauth-server.html#~initOauthServerGrant">initOauthServerGrant</a></li><li data-type='method'><a href="module-lazuli-authentication_oauth-server.html#~verifyOauthClient">verifyOauthClient</a></li></ul></li><li><a href="module-lazuli-authentication_passport.html">lazuli-authentication/passport</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_passport.html#.initGenericOauthPassportStrategy">initGenericOauthPassportStrategy</a></li><li data-type='method'><a href="module-lazuli-authentication_passport.html#~initLocalAuthentication">initLocalAuthentication</a></li><li data-type='method'><a href="module-lazuli-authentication_passport.html#~initOauthBearerAuthentication">initOauthBearerAuthentication</a></li><li data-type='method'><a href="module-lazuli-authentication_passport.html#~initOauthClientAuthentication">initOauthClientAuthentication</a></li><li data-type='method'><a href="module-lazuli-authentication_passport.html#~initPassport">initPassport</a></li><li data-type='method'><a href="module-lazuli-authentication_passport.html#~initPassportSerialization">initPassportSerialization</a></li></ul></li><li><a href="module-lazuli-authentication_schema_oauth-client.html">lazuli-authentication/schema/oauth-client</a></li><li><a href="module-lazuli-authentication_schema_user.html">lazuli-authentication/schema/user</a></li><li><a href="module-lazuli-authentication_types_oauth-acccess-token.html">lazuli-authentication/types/oauth-acccess-token</a></li><li><a href="module-lazuli-authentication_types_oauth-client.html">lazuli-authentication/types/oauth-client</a></li><li><a href="module-lazuli-authentication_types_oauth-code.html">lazuli-authentication/types/oauth-code</a></li><li><a href="module-lazuli-authentication_types_oauth-provider.html">lazuli-authentication/types/oauth-provider</a></li><li><a href="module-lazuli-authentication_types_oauth-redirect-uri.html">lazuli-authentication/types/oauth-redirect-uri</a></li><li><a href="module-lazuli-authentication_types_oauth-scope.html">lazuli-authentication/types/oauth-scope</a></li><li><a href="module-lazuli-authentication_types_permission.html">lazuli-authentication/types/permission</a></li><li><a href="module-lazuli-authentication_types_user.html">lazuli-authentication/types/user</a></li><li><a href="module-lazuli-authentication_utilities_crypto.html">lazuli-authentication/utilities/crypto</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_utilities_crypto.html#~generateHash">generateHash</a></li><li data-type='method'><a href="module-lazuli-authentication_utilities_crypto.html#~generateRandomAlphanumString">generateRandomAlphanumString</a></li><li data-type='method'><a href="module-lazuli-authentication_utilities_crypto.html#~generateRandomString">generateRandomString</a></li></ul></li><li><a href="module-lazuli-authentication_utilities_graphql.html">lazuli-authentication/utilities/graphql</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_utilities_graphql.html#.checkAuthorization">checkAuthorization</a></li><li data-type='method'><a href="module-lazuli-authentication_utilities_graphql.html#.protectGraphqlSchemaFields">protectGraphqlSchemaFields</a></li></ul></li><li><a href="module-lazuli-authentication_utilities_object.html">lazuli-authentication/utilities/object</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_utilities_object.html#.pick">pick</a></li></ul></li><li><a href="module-lazuli-authentication_utilities_sql.html">lazuli-authentication/utilities/sql</a><ul class='methods'><li data-type='method'><a href="module-lazuli-authentication_utilities_sql.html#.escapeLikeString">escapeLikeString</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="module-lazuli-authentication_models_oauth-access-token.html#~event:%2522authentication.model.oauth-access-token.association%2522">"authentication.model.oauth-access-token.association"</a></li><li><a href="module-lazuli-authentication_models_oauth-client.html#~event:%2522authentication.model.oauth-client.association%2522">"authentication.model.oauth-client.association"</a></li><li><a href="module-lazuli-authentication_models_oauth-code.html#~event:%2522authentication.model.oauth-code.association%2522">"authentication.model.oauth-code.association"</a></li><li><a href="module-lazuli-authentication_models_oauth-provider.html#~event:%2522authentication.model.oauth-provider.association%2522">"authentication.model.oauth-provider.association"</a></li><li><a href="module-lazuli-authentication_models_oauth-redirect-uri.html#~event:%2522authentication.model.oauth-redirect-uri.association%2522">"authentication.model.oauth-redirect-uri.association"</a></li><li><a href="module-lazuli-authentication_models_oauth-scope.html#~event:%2522authentication.model.oauth-scope.association%2522">"authentication.model.oauth-scope.association"</a></li><li><a href="module-lazuli-authentication_models_permission.html#~event:%2522authentication.model.permission.association%2522">"authentication.model.permission.association"</a></li><li><a href="module-lazuli-authentication_models_user.html#~event:%2522authentication.model.user.association%2522">"authentication.model.user.association"</a></li><li><a href="module-lazuli-authentication_models_user.html#~event:%2522authentication.model.user.email-verification%2522">"authentication.model.user.email-verification"</a></li><li><a href="module-lazuli-authentication_models_user.html#~event:%2522authentication.model.user.from-passport-profile.after%2522">"authentication.model.user.from-passport-profile.after"</a></li><li><a href="module-lazuli-authentication_models_user.html#~event:%2522authentication.model.user.from-passport-profile.before%2522">"authentication.model.user.from-passport-profile.before"</a></li><li><a href="module-lazuli-authentication_models_user.html#~event:%2522authentication.model.user.password-reset%2522">"authentication.model.user.password-reset"</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">schemas/oauth-client.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {
	GraphQLSchema,
	GraphQLObjectType,
	GraphQLString,
	GraphQLBoolean,
	GraphQLInt,
	GraphQLNonNull,
	GraphQLList
} = require("graphql");

const Joi = require("joi");

const { Op } = require("sequelize");
const { attributeFields, resolver } = require("graphql-sequelize");

const eventEmitter = require("lazuli-require")("lazuli-core/event-emitter");
const valueFilter = require("lazuli-require")("lazuli-core/value-filter");
const sequelize = require("lazuli-require")("lazuli-core/sequelize");

const { pick } = require("../utilities/object");
const { escapeLikeString } = require("../utilities/sql");
const { checkAuthorization } = require("../utilities/graphql");

const OauthClient = require("../models/oauth-client");
const OauthRedirectUri = require("../models/oauth-redirect-uri");

const OauthClientInputType = require("../input-types/oauth-client");
const OauthClientInputTypeValidation = require("../graphql-validation/oauth-client");

/**
 * The graphql schema for the oauth client model
 * @module lazuli-authentication/schema/oauth-client
 * 
 * @filterable {object} authentication.graphql.query.oauth-client.list.args The client properties everyone can query
 * @filterable {object} authentication.graphql.mutation.oauth-client.upsert.keys The client properties the owner can update
 * 
 * @see module:lazuli-authentication/types/oauth-client
 * @see module:lazuli-authentication/input-types/oauth-client
 * @see module:lazuli-authentication/models/oauth-client
 */

/**
 * The graphql query schema
 * @type {object}
 */
module.exports.query = {
	oauthClient: {
		type: OauthClient.graphQlType,
		args: {
			id: {
				description: "The id of the oauth client",
				type: new GraphQLNonNull(GraphQLInt)
			}
		},
		resolve: (root, args, context, info) => {
			return checkAuthorization(context.request.user).then(() => {
				return resolver(OauthClient)(root, args, context, info);
			});
		}
	},
	oauthClients: {
		type: new GraphQLList(OauthClient.graphQlType),
		args: {
			//generally allow to filter all fields
			...attributeFields(OauthClient, { allowNull: true }),
			limit: {
				type: GraphQLInt
			}
		},
		resolve: (root, args, context, info) => {
			const { request: { user } } = context;

			return checkAuthorization(user, "admin.oauth-client.list")
				.then(() => {
					return user.can("admin.oauth-client.get").catch(() => {
						//only allow uncritical search keys
						args = pick(
							args,
							valueFilter.filterable(
								"authentication.graphql.query.oauth-client.list.args",
								["id", "name"]
							)
						);
					});
				})
				.then(() =>
					resolver(OauthClient, {
						before: (findOptions, args) => {
							if (findOptions.where) {
								if (findOptions.where.name) {
									findOptions.where.name = {
										[Op.like]: `%${escapeLikeString(args.name)}%`
									};
								}
							}

							return findOptions;
						}
					})(root, args, context, info)
				);
		}
	}
};

/**
 * The graphql mutation schema
 * @type {object}
 */
module.exports.mutation = {
	upsertOauthClient: {
		type: OauthClient.graphQlType,
		args: {
			oauthClient: { type: new GraphQLNonNull(OauthClientInputType) }
		},
		resolve: (root, { oauthClient: input }, context, info) => {
			//first check if the passed oauthClient object meets all requirements.
			//graphql only checks the input types.
			const staticValidation = Joi.validate(
				input,
				OauthClientInputTypeValidation
			);

			const { request: { user } } = context;

			if (staticValidation.error) {
				return Promise.reject(staticValidation.error);
			}

			let secret = null;

			//If there's no error check what we need to do: update or insert
			return checkAuthorization(user)
				.then(() => {
					if (input.id) {
						//if the oauthClient object contains an id it's not sure yet what
						//action should be taken.
						//should a oauth client with the given id exist, it will be
						//updated
						return OauthClient.findById(input.id).then(oauthClientModel => {
							if (oauthClientModel) {
								return user
									.can("admin.oauth-client.update")
									.catch(err => {
										if (
											oauthClientModel.get("userId") !== request.user.get("id")
										) {
											return Promise.reject(err);
										}
									})
									.then(() => Promise.resolve(oauthClientModel));
							} else {
								//if not, a new oauth client with the given id will be created
								return user
									.can("admin.oauth-client.create")
									.then(() =>
										OauthClient.create({
											id: input.id
										})
									)
									.then(model => {
										secret = input.generateSecret();

										return input
											.updateSecret(secret)
											.then(() => Promise.resolve(model));
									});
							}
						});
					} else {
						//if the oauth client object doesn't contain an id,
						//a new oauth client will be created

						return user
							.can("admin.oauth-client.create")
							.then(() => OauthClient.create())
							.then(model => {
								secret = OauthClient.generateSecret();

								return model
									.updateSecret(secret)
									.then(() => Promise.resolve(model));
							});
					}
				})
				.then(oauthClientModel => {
					//all of the previous possibilities will return a promise returning
					//the oauth client model to update

					//if the user posseses the required permission, all given
					//keys will be updated
					return (
						user
							.can("admin.oauth-client.upsert")
							.catch(err => {
								if (user.get("id") !== oauthClientModel.get("userId")) {
									return Promise.reject(err);
								}

								//otherwise we pick a few
								oauthClientModel.set(
									pick(
										user,
										valueFilter.filterable(
											"authentication.graphql.mutation.oauth-client.upsert.keys",
											["name"]
										)
									)
								);
							})
							.then(() => oauthClientModel.set(input))
							//after setting the new values, save the oauth client model
							.then(() => oauthClientModel.save())
							.then(() => {
								//after saving all columns in the oauth client table we also
								//have to update the associations

								if (!input.oauthRedirectUris) {
									return Promise.resolve();
								}

								//if the user is allowed to, we update the redirect uris
								return oauthClientModel
									.getOauthRedirectUris()
									.then(redirectUriModels => {
										//diff existing and sent
										const toDelete = redirectUriModels.filter(
											redirectUriModel => {
												return (
													input.oauthRedirectUris.indexOf(
														redirectUriModel.get("uri")
													) === -1
												);
											}
										);

										const existing = redirectUriModels.map(redirectUriModel =>
											redirectUriModel.get("uri")
										);
										const toAdd = input.oauthRedirectUris.filter(
											redirectUri => {
												return existing.indexOf(redirectUri) === -1;
											}
										);

										return Promise.all([
											...toDelete.map(redirectUriModel => {
												return redirectUriModel.destroy();
											}),
											...toAdd.map(redirectUri =>
												OauthRedirectUri.create({
													uri: redirectUri,
													oauthClientId: oauthClientModel.get("id")
												})
											)
										]);
									});
							})
							.then(() => {
								//in the end, we return the updated oauth client object by
								//using graphql-sequelize's resolver

								return resolver(OauthClient)(
									root,
									{ id: oauthClientModel.get("id") },
									context,
									info
								).then(model => {
									if (secret) {
										model.dataValues.secret = secret;
									}
									return Promise.resolve(model);
								});
							})
					);
				});
		}
	},
	deleteOauthClient: {
		type: GraphQLBoolean,
		args: {
			id: { type: GraphQLInt }
		},
		resolve: (root, { id }, { request: { user } }, info) => {
			return checkAuthorization(user).then(() => {
				return OauthClient.findById(id).then(oauthClientModel => {
					if (!oauthClientModel) {
						return Promise.reject(
							new Error("The given oauth client couldn't be found!")
						);
					}
					return user
						.can("admin.oauth-client.delete")
						.catch(err => {
							if (oauthClientModel.get("userId") !== user.get("id")) {
								return Promise.reject(err);
							}
						})
						.then(() => oauthClientModel.destroy())
						.then(() => Promise.resolve(true));
				});
			});
		}
	}
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Nov 06 2017 21:34:57 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
